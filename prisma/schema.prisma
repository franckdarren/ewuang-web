datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model article_commandes {
  id          String   @id @default(uuid()) @db.Uuid
  article_id  String   @db.Uuid
  commande_id String   @db.Uuid
  quantite    Int
  prix        Int
  reduction   Int
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now())

  // Relations
  articles  articles  @relation(fields: [article_id], references: [id])
  commandes commandes @relation(fields: [commande_id], references: [id])

  @@index([article_id])
  @@index([commande_id])
}

model articles {
  id                    String    @id @default(uuid()) @db.Uuid
  nom                   String    @db.VarChar(255)
  description           String?   @db.VarChar(255)
  prix                  Int
  prix_promotion        Int?
  is_promotion          Boolean   @default(false)
  pourcentage_reduction Int       @default(0)
  made_in_gabon         Boolean   @default(false)
  user_id               String    @db.Uuid
  categorie_id          String?   @db.Uuid
  // categorie             String    @db.VarChar(255)
  image_principale      String?   @db.VarChar(255)
  is_active             Boolean   @default(true)
  created_at            DateTime? @default(now())
  updated_at            DateTime? @updatedAt

  // Relations
  article_commandes article_commandes[]
  commande_articles commande_articles[]
  image_articles    image_articles[]
  variations        variations[]
  users             users               @relation(fields: [user_id], references: [id])
  favoris           favoris[]
  avis              avis[]
  categories        categories?         @relation(fields: [categorie_id], references: [id])
  panier_items      panier_items[]

  @@index([user_id])
  @@index([categorie_id])
  @@index([is_promotion])
  @@index([is_active])
}

model commande_articles {
  id            String   @id @default(uuid()) @db.Uuid
  commande_id   String   @db.Uuid
  article_id    String   @db.Uuid
  variation_id  String?  @db.Uuid
  quantite      Int
  prix_unitaire Int
  created_at    DateTime @default(now())
  updated_at    DateTime @default(now())

  // Relations
  articles   articles    @relation(fields: [article_id], references: [id])
  commandes  commandes   @relation(fields: [commande_id], references: [id])
  variations variations? @relation(fields: [variation_id], references: [id])

  @@index([article_id])
  @@index([commande_id])
  @@index([variation_id])
}

model commandes {
  id                String           @id @default(uuid()) @db.Uuid
  numero            String           @db.VarChar(255)
  statut            commandes_statut @default(en_attente)
  prix              Int
  commentaire       String           @db.VarChar(255)
  isLivrable        Boolean
  user_id           String           @db.Uuid
  vendeur_id        String?          @db.Uuid
  paiement_id       String?          @unique @db.Uuid
  created_at        DateTime         @default(now())
  updated_at        DateTime         @updatedAt
  adresse_livraison String           @db.VarChar(255)

  // Relations
  article_commandes article_commandes[]
  commande_articles commande_articles[]
  users             users               @relation(fields: [user_id], references: [id])
  paiements         paiements?          @relation(fields: [paiement_id], references: [id])
  livraisons        livraisons[]
  reclamations      reclamations[]

  @@index([user_id])
  @@index([vendeur_id])
  @@index([statut])
  @@index([created_at])
}

model image_articles {
  id           String   @id @default(uuid()) @db.Uuid
  url_photo    String   @db.VarChar(255)
  variation_id String?  @db.Uuid
  article_id   String   @db.Uuid
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now())

  // Relations
  articles   articles    @relation(fields: [article_id], references: [id])
  variations variations? @relation(fields: [variation_id], references: [id])

  @@index([article_id])
  @@index([variation_id])
}

model livraisons {
  id             String   @id @default(uuid()) @db.Uuid
  adresse        String   @db.VarChar(255)
  details        String   @db.VarChar(255)
  statut         String   @db.VarChar(255)
  date_livraison DateTime
  ville          String   @db.VarChar(255)
  phone          String   @db.VarChar(255)
  commande_id    String   @db.Uuid
  user_id        String?  @db.Uuid
  livreur_id     String?
  created_at     DateTime @default(now())
  updated_at     DateTime @default(now())

  // Relations
  commandes commandes @relation(fields: [commande_id], references: [id])
  users     users?    @relation(fields: [user_id], references: [id])

  @@index([commande_id])
  @@index([user_id])
  @@index([livreur_id])
  @@index([statut])
}

model publicites {
  id          String   @id @default(uuid()) @db.Uuid
  date_start  DateTime
  date_end    DateTime
  titre       String   @db.VarChar(255)
  url_image   String   @db.VarChar(255)
  lien        String   @db.VarChar(255)
  description String
  is_actif    Boolean
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now())
}

model reclamations {
  id          String              @id @default(uuid()) @db.Uuid
  description String              @db.VarChar(255)
  phone       String              @db.VarChar(255)
  statut      reclamations_statut @default(en_attente_de_traitement)
  commande_id String              @db.Uuid
  user_id     String              @db.Uuid
  reponse     String?             @db.Text // Nouveau : réponse de l'admin
  created_at  DateTime            @default(now())
  updated_at  DateTime            @updatedAt

  // Relations
  commandes commandes @relation(fields: [commande_id], references: [id])
  users     users     @relation(fields: [user_id], references: [id])

  @@index([commande_id])
  @@index([user_id])
  @@index([statut])
}

model stocks {
  id           String   @id @default(uuid()) @db.Uuid
  variation_id String   @db.Uuid
  quantite     Int      @default(0)
  seuil_alerte Int      @default(5)
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now())

  // Relations
  variations variations @relation(fields: [variation_id], references: [id])

  @@index([variation_id])
  @@index([quantite])
}

model users {
  id              String   @id @default(uuid()) @db.Uuid
  auth_id         String?  @unique @db.Uuid
  name            String   @db.VarChar(255)
  role            String   @db.VarChar(255)
  email           String   @unique @db.VarChar(255)
  url_logo        String?  @db.VarChar(255)
  phone           String?  @db.VarChar(255)
  heure_ouverture String?
  heure_fermeture String?
  description     String?
  address         String?
  solde           Int      @default(0)
  is_verified     Boolean  @default(false) // Nouveau : compte vérifié
  is_active       Boolean  @default(true) // Nouveau : compte actif
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now())

  // Relations
  articles               articles[]
  commandes              commandes[]
  livraisons             livraisons[]
  reclamations           reclamations[]
  favoris                favoris[]
  avis                   avis[]
  notifications          notifications[]
  conversations_sent     conversations[] @relation("sender")
  conversations_received conversations[] @relation("receiver")
  paniers                paniers[]
  paiements              paiements[]

  @@index([email])
  @@index([role])
  @@index([is_active])
}

model variations {
  id         String    @id @default(uuid()) @db.Uuid
  article_id String    @db.Uuid
  couleur    String?   @db.VarChar(255)
  taille     String?   @db.VarChar(255)
  stock      Int       @default(0)
  prix       Int?
  image      String?   @db.VarChar(255)
  created_at DateTime? @default(now())
  updated_at DateTime? @updatedAt

  // Relations
  commande_articles commande_articles[]
  image_articles    image_articles[]
  stocks            stocks[]
  articles          articles            @relation(fields: [article_id], references: [id])
  panier_items      panier_items[]

  @@index([article_id])
}

model favoris {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  article_id String   @db.Uuid
  created_at DateTime @default(now())

  // Relations
  users    users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  articles articles @relation(fields: [article_id], references: [id], onDelete: Cascade)

  @@unique([user_id, article_id]) // Un utilisateur ne peut favoriser qu'une fois le même article
  @@index([user_id])
  @@index([article_id])
}

model avis {
  id           String   @id @default(uuid()) @db.Uuid
  user_id      String   @db.Uuid
  article_id   String   @db.Uuid
  note         Int // Note sur 5
  commentaire  String?  @db.Text
  is_moderated Boolean  @default(false) // Pour modération admin
  is_visible   Boolean  @default(true) // Visibilité publique
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  // Relations
  users    users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  articles articles @relation(fields: [article_id], references: [id], onDelete: Cascade)

  @@unique([user_id, article_id]) // Un utilisateur ne peut noter qu'une fois le même article
  @@index([user_id])
  @@index([article_id])
  @@index([note]) // Pour filtrer par note
}

model categories {
  id          String   @id @default(uuid()) @db.Uuid
  nom         String   @unique @db.VarChar(255)
  slug        String   @unique @db.VarChar(255)
  description String?  @db.Text
  image       String?  @db.VarChar(255)
  parent_id   String?  @db.Uuid
  is_active   Boolean  @default(true)
  ordre       Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  parent   categories?  @relation("CategoryHierarchy", fields: [parent_id], references: [id])
  children categories[] @relation("CategoryHierarchy")
  articles articles[]

  @@index([parent_id])
  @@index([slug])
  @@index([is_active])
}

model paiements {
  id             String          @id @default(uuid()) @db.Uuid
  user_id        String          @db.Uuid
  montant        Int
  methode        String          @db.VarChar(50) // carte, mobile_money, especes
  statut         paiement_statut @default(en_attente)
  reference      String          @unique @db.VarChar(255)
  transaction_id String?         @db.VarChar(255)
  details        Json? // Infos supplémentaires du provider
  created_at     DateTime        @default(now())
  updated_at     DateTime        @updatedAt

  // Relations
  users     users       @relation(fields: [user_id], references: [id])
  commandes commandes[]

  @@index([user_id])
  @@index([reference])
  @@index([statut])
}

model notifications {
  id         String            @id @default(uuid()) @db.Uuid
  user_id    String            @db.Uuid
  type       notification_type
  titre      String            @db.VarChar(255)
  message    String            @db.Text
  lien       String?           @db.VarChar(255)
  is_read    Boolean           @default(false)
  created_at DateTime          @default(now())

  // Relations
  users users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([is_read])
  @@index([created_at])
}

model conversations {
  id          String   @id @default(uuid()) @db.Uuid
  sender_id   String   @db.Uuid
  receiver_id String   @db.Uuid
  message     String   @db.Text
  is_read     Boolean  @default(false)
  created_at  DateTime @default(now())

  // Relations
  sender   users @relation("sender", fields: [sender_id], references: [id], onDelete: Cascade)
  receiver users @relation("receiver", fields: [receiver_id], references: [id], onDelete: Cascade)

  @@index([sender_id])
  @@index([receiver_id])
  @@index([is_read])
  @@index([created_at])
}

model paniers {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @unique @db.Uuid
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  users        users          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  panier_items panier_items[]

  @@index([user_id])
}

model panier_items {
  id           String   @id @default(uuid()) @db.Uuid
  panier_id    String   @db.Uuid
  article_id   String   @db.Uuid
  variation_id String?  @db.Uuid
  quantite     Int      @default(1)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  // Relations
  paniers    paniers     @relation(fields: [panier_id], references: [id], onDelete: Cascade)
  articles   articles    @relation(fields: [article_id], references: [id], onDelete: Cascade)
  variations variations? @relation(fields: [variation_id], references: [id])

  @@unique([panier_id, article_id, variation_id])
  @@index([panier_id])
  @@index([article_id])
  @@index([variation_id])
}

enum commandes_statut {
  en_attente            @map("En attente")
  en_preparation        @map("En préparation")
  prete_pour_livraison  @map("Prête pour livraison")
  en_cours_de_livraison @map("En cours de livraison")
  livree                @map("Livrée")
  annule                @map("Annulée")
  rembourse             @map("Remboursée")
}

enum reclamations_statut {
  en_attente_de_traitement @map("En attente de traitement")
  en_cours                 @map("En cours")
  rejete                   @map("Rejetée")
  rembourse                @map("Remboursée")
}

enum paiement_statut {
  en_attente @map("En attente")
  valide     @map("Validé")
  echoue     @map("Echoué")
  rembourse  @map("Remboursée")
}

enum notification_type {
  commande     @map("Commande")
  livraison    @map("Livraison")
  message      @map("Message")
  promotion    @map("Promotion")
  alerte_stock @map("Alerte stock")
  avis         @map("Avis")
  systeme      @map("Système")
}
